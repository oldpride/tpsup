#!/bin/bash


prog=`basename $0`
posdir=$HOME/.tpsup
posfile=$posdir/puttypos.cache

max=9

usage () {
   cat >&2 <<EOF
usage:

   $prog pos

   position the current putty's window at position.

   pos can be
      - 0, 1, 2, 3, ... $max 
      - next  - position in $posfile + 1
      - reset - this set the cache pos to max, so that the next one restart from 0.
                ths doesn't move the current putty's position.

   if $posfile has no cached position, then next will be 1.

EOF
   exit 1
}


verbose=N
while getopts v o;
do
   case "$o" in
       v)   verbose=Y;;
      #c)   UseCmd=Y;;
      #u)  id=$OPTARG;;
      *)   usage;;
   esac
done

shift $((OPTIND-1))

if [ $# -ne 1 ]; then
   echo "wrong number of args" >&2
   usage
fi

pos=$1

[ -d $posdir ] || mkdir -p $posdir

if [ $pos = reset ]; then
   # reset doesn't change current putty's position.
   echo $max  >$posfile
   exit 0;
elif [ $pos = next ]; then
   touch $posfile
   cachepos=`cat $posfile`;

   if [[ $cachepos =~ ^[0-9]+$ ]]; then
      if [ $cachepos -ge $max ]; then
         # cache pos is at max, the next one will be 0
         pos=0
      else
         pos=`expr $cachepos + 1`
      fi
   else
      pos=0
   fi
else 
   if ! [[ $pos =~ ^[0-9]+$ ]]; then  # bash regex
      echo "unsupported pos='$pos'" >&2
      usage
   fi

   if [ $pos -gt $max ]; then
      echo "max pos=$max, your pos='$pos'" >&2
      usage
   fi
fi

offset=`expr 30 \* $pos`

printf '\033[3;'"$offset;$offset"'t'

echo $pos >$posfile
